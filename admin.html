<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>åå°ç®¡ç† - ä½ç«¯å½±è§†</title>
    <script src="libs/tailwindcss.min.js"></script>
    <style>
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .progress-bar { transition: width 0.3s ease; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 min-h-screen text-white">
    <!-- ç™»å½•é¡µé¢ -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-slate-800/50 backdrop-blur-xl rounded-2xl p-8 w-full max-w-md border border-slate-700">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-br from-sky-500 to-cyan-500 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <span class="text-3xl">ğŸ¬</span>
                </div>
                <h1 class="text-2xl font-bold">ä½ç«¯å½±è§† åå°ç®¡ç†</h1>
                <p class="text-slate-400 mt-2">è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ç™»å½•</p>
            </div>
            <form onsubmit="handleLogin(event)">
                <input type="password" id="passwordInput" placeholder="ç®¡ç†å‘˜å¯†ç "
                    class="w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:border-sky-500 mb-4">
                <button type="submit" id="loginBtn"
                    class="w-full py-3 bg-gradient-to-r from-sky-500 to-cyan-500 hover:from-sky-600 hover:to-cyan-600 text-white rounded-xl font-medium transition-all">
                    ç™»å½•
                </button>
            </form>
            <p id="loginError" class="text-red-400 text-center mt-4 hidden"></p>
        </div>
    </div>

    <!-- ç®¡ç†é¢æ¿ -->
    <div id="adminPanel" class="hidden">
        <header class="bg-slate-800/80 backdrop-blur-xl border-b border-slate-700 sticky top-0 z-10">
            <div class="container mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-sky-500 to-cyan-500 rounded-xl flex items-center justify-center">
                        <span class="text-xl">ğŸ¬</span>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">åå°ç®¡ç†</h1>
                        <p class="text-xs text-slate-400">æ•°æ®åŒæ­¥ä¸ç®¡ç†</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <a href="/" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition-colors">è¿”å›é¦–é¡µ</a>
                    <button onclick="handleLogout()" class="px-4 py-2 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg text-sm transition-colors">é€€å‡ºç™»å½•</button>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-4 py-8 space-y-6">
            <!-- åŒæ­¥çŠ¶æ€å¡ç‰‡ -->
            <div class="bg-slate-800/50 backdrop-blur-xl rounded-2xl p-6 border border-slate-700">
                <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <span>ğŸ“Š</span> åŒæ­¥çŠ¶æ€
                </h2>
                <div id="statusContent" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div class="bg-slate-700/50 rounded-xl p-4 text-center">
                        <p class="text-slate-400 text-sm">çŠ¶æ€</p>
                        <p id="syncStatus" class="text-xl font-bold text-sky-400">-</p>
                    </div>
                    <div class="bg-slate-700/50 rounded-xl p-4 text-center">
                        <p class="text-slate-400 text-sm">è§†é¢‘æ€»æ•°</p>
                        <p id="totalVideos" class="text-xl font-bold text-green-400">-</p>
                    </div>
                    <div class="bg-slate-700/50 rounded-xl p-4 text-center">
                        <p class="text-slate-400 text-sm">åˆ†ç±»æ•°é‡</p>
                        <p id="totalCategories" class="text-xl font-bold text-purple-400">-</p>
                    </div>
                    <div class="bg-slate-700/50 rounded-xl p-4 text-center">
                        <p class="text-slate-400 text-sm">ä¸Šæ¬¡åŒæ­¥</p>
                        <p id="lastSync" class="text-xl font-bold text-orange-400">-</p>
                    </div>
                </div>
                <!-- åŒæ­¥è¿›åº¦ï¼ˆåŒæ­¥ä¸­æ˜¾ç¤ºï¼‰ -->
                <div id="progressSection" class="hidden bg-slate-700/30 rounded-xl p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span id="progressPhase" class="text-sm text-slate-300">å‡†å¤‡ä¸­...</span>
                        <span id="progressPercent" class="text-sm text-sky-400">0%</span>
                    </div>
                    <div class="w-full bg-slate-600 rounded-full h-2 mb-2">
                        <div id="progressBar" class="progress-bar bg-gradient-to-r from-sky-500 to-cyan-500 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                    <div class="flex items-center justify-between text-xs text-slate-400">
                        <span>ğŸ“¦ æ­£åœ¨å¤„ç†: <span id="currentCategory" class="text-white">-</span></span>
                        <span>ğŸ¬ å·²è·å–: <span id="videosCount" class="text-green-400">0</span> æ¡è§†é¢‘</span>
                    </div>
                </div>
            </div>

            <!-- æ•°æ®æºé…ç½® -->
            <div class="bg-slate-800/50 backdrop-blur-xl rounded-2xl p-6 border border-slate-700">
                <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <span>âš™ï¸</span> æ•°æ®æºé…ç½®
                </h2>
                <div class="mb-4">
                    <label class="block text-sm text-slate-400 mb-2">å½“å‰æ•°æ®æº</label>
                    <p id="currentSource" class="text-sky-400 text-sm break-all mb-3">-</p>
                    <input type="text" id="sourceUrlInput" placeholder="è¯·è¾“å…¥ API æºåœ°å€ï¼Œå¦‚: https://example.com/api.php/provide/vod/"
                        class="w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:border-sky-500">
                </div>
                <div class="flex gap-3">
                    <button onclick="saveSourceConfig()" class="px-4 py-2 bg-sky-500 hover:bg-sky-600 text-white rounded-lg text-sm transition-colors">
                        ğŸ’¾ ä¿å­˜æ•°æ®æº
                    </button>
                </div>
                <p id="sourceResult" class="mt-3 text-sm hidden"></p>
            </div>

            <!-- è¿‡æ»¤è§„åˆ™ -->
            <div class="bg-slate-800/50 backdrop-blur-xl rounded-2xl p-6 border border-slate-700">
                <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <span>ğŸš«</span> è¿‡æ»¤è§„åˆ™
                </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-slate-400 mb-2">ç¦æ­¢åˆ†ç±»ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                        <textarea id="bannedTypesInput" rows="3" placeholder="ä¼¦ç†ç‰‡,ç¦åˆ©,çŸ­å‰§,å¤§é™†å‰§..."
                            class="w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:border-sky-500 text-sm"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-2">ç¦æ­¢åœ°åŒºï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                        <input type="text" id="bannedAreasInput" placeholder="å¤§é™†,ä¸­å›½å¤§é™†,å†…åœ°"
                            class="w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:border-sky-500 text-sm">
                    </div>
                </div>
                <div class="flex gap-3 mt-4">
                    <button onclick="saveFilterConfig()" class="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg text-sm transition-colors">
                        ğŸ’¾ ä¿å­˜è¿‡æ»¤è§„åˆ™
                    </button>
                    <button onclick="resetFilterConfig()" class="px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg text-sm transition-colors">
                        ğŸ”„ æ¢å¤é»˜è®¤
                    </button>
                </div>
                <p id="filterResult" class="mt-3 text-sm hidden"></p>
            </div>

            <!-- æ“ä½œåŒºåŸŸ -->
            <div class="bg-slate-800/50 backdrop-blur-xl rounded-2xl p-6 border border-slate-700">
                <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <span>âš¡</span> æ•°æ®æ“ä½œ
                </h2>
                <p class="text-slate-400 mb-4">åŒæ­¥æ•°æ®ã€åœæ­¢åŒæ­¥æˆ–æ¸…ç©ºæ‰€æœ‰ç¼“å­˜æ•°æ®ã€‚</p>
                <div class="flex flex-wrap gap-3">
                    <button onclick="handleSync()" id="syncBtn"
                        class="px-6 py-3 bg-gradient-to-r from-sky-500 to-cyan-500 hover:from-sky-600 hover:to-cyan-600 text-white rounded-xl font-medium transition-all flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span id="syncIcon">ğŸ”„</span>
                        <span id="syncText">ç«‹å³åŒæ­¥</span>
                    </button>
                    <button onclick="handleStopSync()" id="stopBtn"
                        class="hidden px-6 py-3 bg-orange-500 hover:bg-orange-600 text-white rounded-xl font-medium transition-all flex items-center gap-2">
                        <span>â¹ï¸</span>
                        <span>åœæ­¢åŒæ­¥</span>
                    </button>
                    <button onclick="handleClearData()" id="clearBtn"
                        class="px-6 py-3 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-xl font-medium transition-all flex items-center gap-2">
                        <span>ğŸ—‘ï¸</span>
                        <span>æ¸…ç©ºæ•°æ®</span>
                    </button>
                </div>
                <p id="syncResult" class="mt-4 text-sm hidden"></p>
            </div>
        </main>
    </div>

    <script>
        let isSyncing = false;
        let progressInterval = null;

        // é»˜è®¤è¿‡æ»¤è§„åˆ™
        const DEFAULT_BANNED_TYPES = ['ä¼¦ç†ç‰‡','ç¦åˆ©','é‡Œç•ªåŠ¨æ¼«','é—¨äº‹ä»¶','èè‰å°‘å¥³','åˆ¶æœè¯±æƒ‘','å›½äº§ä¼ åª’','cosplay','é»‘ä¸è¯±æƒ‘','æ— ç ','æ—¥æœ¬æ— ç ','æœ‰ç ','æ—¥æœ¬æœ‰ç ','SWAG','ç½‘çº¢ä¸»æ’­','è‰²æƒ…ç‰‡','åŒæ€§ç‰‡','ç¦åˆ©è§†é¢‘','ç¦åˆ©ç‰‡','å›½äº§åŠ¨æ¼«','å¤§é™†ç»¼è‰º','å›½äº§å‰§','çŸ­å‰§','å¤§é™†å‰§','ä¸­å›½åŠ¨æ¼«'];
        const DEFAULT_BANNED_AREAS = ['å¤§é™†','ä¸­å›½å¤§é™†','å†…åœ°'];

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkAuth() {
            try {
                const res = await fetch('/api/admin/verify');
                const data = await res.json();
                if (data.authenticated) {
                    showAdminPanel();
                    loadStatus();
                    loadConfig();
                }
            } catch (e) { console.error(e); }
        }

        // æ˜¾ç¤ºç®¡ç†é¢æ¿
        function showAdminPanel() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
        }

        // ç™»å½•
        async function handleLogin(e) {
            e.preventDefault();
            const password = document.getElementById('passwordInput').value;
            const errorEl = document.getElementById('loginError');
            const btn = document.getElementById('loginBtn');

            btn.disabled = true;
            btn.textContent = 'ç™»å½•ä¸­...';
            errorEl.classList.add('hidden');

            try {
                const res = await fetch('/api/admin/auth?action=login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                const data = await res.json();
                if (res.ok) {
                    showAdminPanel();
                    loadStatus();
                    loadConfig();
                } else {
                    errorEl.textContent = data.error || 'ç™»å½•å¤±è´¥';
                    errorEl.classList.remove('hidden');
                }
            } catch (err) {
                errorEl.textContent = 'ç½‘ç»œé”™è¯¯';
                errorEl.classList.remove('hidden');
            }
            btn.disabled = false;
            btn.textContent = 'ç™»å½•';
        }

        // é€€å‡ºç™»å½•
        async function handleLogout() {
            await fetch('/api/admin/auth?action=logout');
            location.reload();
        }

        // åŠ è½½é…ç½®
        async function loadConfig() {
            try {
                const res = await fetch('/api/admin/settings');
                const data = await res.json();
                if (data.success && data.data) {
                    const d = data.data;
                    document.getElementById('currentSource').textContent = d.sourceUrl || 'é»˜è®¤æº';
                    document.getElementById('bannedTypesInput').value = (d.bannedTypes || DEFAULT_BANNED_TYPES).join(',');
                    document.getElementById('bannedAreasInput').value = (d.bannedAreas || DEFAULT_BANNED_AREAS).join(',');
                }
            } catch (e) { console.error(e); }
        }

        // åŠ è½½çŠ¶æ€
        async function loadStatus() {
            try {
                const res = await fetch('/api/admin/sync');
                const data = await res.json();
                if (data.success && data.data) {
                    const s = data.data;
                    const statusText = s.status === 'success' ? 'âœ… æˆåŠŸ' :
                        s.status === 'syncing' ? 'ğŸ”„ åŒæ­¥ä¸­' :
                        s.status === 'stopped' ? 'â¹ï¸ å·²åœæ­¢' :
                        s.status === 'error' ? 'âŒ å¤±è´¥' : 'â³ æœªåŒæ­¥';

                    document.getElementById('syncStatus').textContent = statusText;
                    document.getElementById('totalVideos').textContent = s.totalVideos || '-';
                    document.getElementById('totalCategories').textContent = s.categories || '-';
                    document.getElementById('lastSync').textContent = s.lastSync
                        ? new Date(s.lastSync).toLocaleString('zh-CN') : '-';

                    // æ›´æ–°è¿›åº¦
                    if (s.status === 'syncing' && data.progress) {
                        updateProgressUI(data.progress);
                        showProgress(true);
                    } else {
                        showProgress(false);
                    }
                }
            } catch (e) { console.error(e); }
        }

        // æ›´æ–°è¿›åº¦UI
        function updateProgressUI(p) {
            const percent = p.totalCategories > 0 ? Math.round((p.processedCategories / p.totalCategories) * 100) : 0;
            document.getElementById('progressPhase').textContent = p.phase || 'åŒæ­¥ä¸­...';
            document.getElementById('progressPercent').textContent = percent + '%';
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('currentCategory').textContent = p.currentCategory || '-';
            document.getElementById('videosCount').textContent = p.videosCount || 0;
        }

        // æ˜¾ç¤º/éšè—è¿›åº¦
        function showProgress(show) {
            document.getElementById('progressSection').classList.toggle('hidden', !show);
            document.getElementById('stopBtn').classList.toggle('hidden', !show);
            document.getElementById('syncBtn').classList.toggle('hidden', show);
        }

        // ä¿å­˜æ•°æ®æº
        async function saveSourceConfig() {
            const url = document.getElementById('sourceUrlInput').value.trim();
            const result = document.getElementById('sourceResult');
            if (!url) { showResult(result, 'è¯·è¾“å…¥æ•°æ®æºåœ°å€', false); return; }

            try {
                const res = await fetch('/api/admin/settings?action=source', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sourceUrl: url })
                });
                const data = await res.json();
                showResult(result, data.message || data.error, data.success);
                if (data.success) {
                    document.getElementById('currentSource').textContent = url;
                    document.getElementById('sourceUrlInput').value = '';
                }
            } catch (e) { showResult(result, 'ç½‘ç»œé”™è¯¯', false); }
        }

        // ä¿å­˜è¿‡æ»¤è§„åˆ™
        async function saveFilterConfig() {
            const types = document.getElementById('bannedTypesInput').value.split(',').map(s => s.trim()).filter(Boolean);
            const areas = document.getElementById('bannedAreasInput').value.split(',').map(s => s.trim()).filter(Boolean);
            const result = document.getElementById('filterResult');

            try {
                const res = await fetch('/api/admin/settings?action=filter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bannedTypes: types, bannedAreas: areas })
                });
                const data = await res.json();
                showResult(result, data.message || data.error, data.success);
            } catch (e) { showResult(result, 'ç½‘ç»œé”™è¯¯', false); }
        }

        // æ¢å¤é»˜è®¤è¿‡æ»¤è§„åˆ™
        function resetFilterConfig() {
            document.getElementById('bannedTypesInput').value = DEFAULT_BANNED_TYPES.join(',');
            document.getElementById('bannedAreasInput').value = DEFAULT_BANNED_AREAS.join(',');
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(el, msg, success) {
            el.textContent = (success ? 'âœ… ' : 'âŒ ') + msg;
            el.className = 'mt-3 text-sm ' + (success ? 'text-green-400' : 'text-red-400');
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        }

        // æ‰§è¡ŒåŒæ­¥
        async function handleSync() {
            const btn = document.getElementById('syncBtn');
            const result = document.getElementById('syncResult');

            btn.disabled = true;
            isSyncing = true;
            showProgress(true);
            result.classList.add('hidden');

            // å¼€å§‹è½®è¯¢è¿›åº¦
            progressInterval = setInterval(loadStatus, 2000);

            try {
                const res = await fetch('/api/admin/sync', { method: 'POST' });
                const data = await res.json();

                if (data.success) {
                    result.textContent = `âœ… åŒæ­¥æˆåŠŸï¼å…± ${data.totalVideos} æ¡è§†é¢‘ï¼Œ${data.categories} ä¸ªåˆ†ç±»ï¼Œè€—æ—¶ ${(data.duration/1000).toFixed(1)} ç§’`;
                    result.className = 'mt-4 text-sm text-green-400';
                } else if (data.stopped) {
                    result.textContent = 'â¹ï¸ åŒæ­¥å·²åœæ­¢';
                    result.className = 'mt-4 text-sm text-orange-400';
                } else {
                    result.textContent = `âŒ åŒæ­¥å¤±è´¥: ${data.error}`;
                    result.className = 'mt-4 text-sm text-red-400';
                }
                result.classList.remove('hidden');
            } catch (err) {
                result.textContent = `âŒ ç½‘ç»œé”™è¯¯: ${err.message}`;
                result.className = 'mt-4 text-sm text-red-400';
                result.classList.remove('hidden');
            }

            clearInterval(progressInterval);
            isSyncing = false;
            btn.disabled = false;
            showProgress(false);
            loadStatus();
        }

        // åœæ­¢åŒæ­¥
        async function handleStopSync() {
            try {
                await fetch('/api/admin/settings?action=stop', { method: 'POST' });
            } catch (e) { console.error(e); }
        }

        // æ¸…ç©ºæ•°æ®
        async function handleClearData() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç¼“å­˜æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

            const result = document.getElementById('syncResult');
            try {
                const res = await fetch('/api/admin/settings?action=clear', { method: 'POST' });
                const data = await res.json();
                showResult(result, data.message || data.error, data.success);
                loadStatus();
            } catch (e) { showResult(result, 'ç½‘ç»œé”™è¯¯', false); }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•
        checkAuth();
    </script>
</body>
</html>

